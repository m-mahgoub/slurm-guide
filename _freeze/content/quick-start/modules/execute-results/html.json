{
  "hash": "7bd15097b49635a3dfb16576ec63d766",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"Modules Usage in Compute2\"\nsubtitle: \"Using Environment Modules and Spack for Software Management\"\npage-layout: article\nanchor-sections: false\nsearch: false\nexecute: \n  eval: false\n---\n\n\n## Background\n\n- Compute2 uses [Environment Modules](https://modules.readthedocs.io/en/latest/index.html) to manage software packages. However, it does *not* handle the installation of those packages.\n\n- While many of the tools we use are available via Docker images, using modules is often preferable for interactive workflows in VS Code or notebooks—especially when integrating with SLURM and other modules that aren't included in Docker environments.\n\n- Compute2 supports [Spack](https://spack.readthedocs.io/en/latest/) for software installation. Spack not only compiles packages from source but also automatically generates modulefiles for each installation. It also supports installing pre-built binaries when available.\n\n- Spack allows you to create isolated environments similar to conda. These environments can include multiple packages and system libraries. Unlike conda, Spack is specifically designed for HPC systems where users typically lack root privileges. It efficiently manages dependencies and enables shared package installations across environments.\n\n## Setup\n\n- I installed essential lab tools using Spack, including `samtools`, `bedtools`, `bcftools`, and many others, along with their dependencies. Additionally, I installed Python and R with commonly used packages for both languages.\n\n- These installations are bundled into a single Spack environment named `labtools`. The environment is configured to support:\n  - Jupyter Server (via both the VS Code interface and web interface)\n  - RStudio Server (VS Code only)\n\n- Note: RStudio Server via the web interface typically requires root access to install, unless running in containers. However, RStudio can be used through VS Code Server via the module system. Full web access is only feasible via containers.\n\n## Quick Start\n\nBefore using any of the installed tools, make sure to **launch an interactive SLURM session**. Avoid running heavy workloads on the login node.\n\n\n```{bash}\nsrun --time=\"4:00:00\" --nodes=1 --ntasks=4 --mem=24G --pty /bin/bash\n```\n\n\nOnce inside an interactive session:\n\n1. **Export the custom module path** to include user-installed environments.\n2. **Load the `labtools` module**, which provides access to the core tools used in the lab.\n\n\n```{bash}\n# Export the modules installation path\nexport MODULEPATH=/storage2/fs1/dspencer/Active/spencerlab/mohamed2/modules/spack/modules/environments:$MODULEPATH\n\n# Load the 'labtools' module\nmodule load labtools\n```\n\n\n:::{.callout-note}\nYou can streamline this setup by adding the export and module load commands to your `.bashrc` file:\n\n- Persistent module path: Add the `export MODULEPATH=...` line to automatically include the custom module path on login.\n- Optional auto-loading of `labtools`:\n  - You may choose to load the `labtools` module by default (e.g., in `.bashrc`).\n  - Alternatively, you can conditionally load it only when working interactively via VS Code Remote-SSH, which is common for development and notebook usage.\n\nHere’s an example `.bashrc` snippet that does both:\n\n\n```{bash}\n# Export the custom module path\nexport MODULEPATH=/storage2/fs1/dspencer/Active/spencerlab/mohamed2/modules/spack/modules/environments:$MODULEPATH\n\n# Conditionally load 'labtools' when using VS Code Remote-SSH\nif [[ -n \"$VSCODE_IPC_HOOK_CLI\" ]]; then\n  echo \"Detected VS Code Remote-SSH session. Loading 'labtools' module...\"\n  module load labtools\nfi\n```\n\n:::\n\nFinally, verify that everything is working by checking the version of a core tool like `samtools`:\n\n\n```{bash}\n#| eval: true\n#| class-output: output\nsamtools --version\n```\n\n\nWith the `labtools` module loaded, now you should have access to most of the tools available in docker base-image, R and Python with commonly used packages.\n\n",
    "supporting": [
      "modules_files/figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}